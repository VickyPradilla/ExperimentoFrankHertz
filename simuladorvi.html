<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Experimento de Franck-Hertz</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        canvas#franckHertzChart {
          width: 100% !important;
          height: 280px !important;
        }
    </style>
</head>
<body>
  <!-- (Contenido original previo: título, tubo, controles, etc.) -->
  <div class="graph-section">
      <div class="graph-title">Franck-Hertz Data for Mercury</div>
      <canvas id="franckHertzChart" width="360" height="280"></canvas>
      <div style="display: flex; justify-content: space-between; margin-top: 10px;">
        <div>Voltaje: <span id="voltageValue">0.0</span> V</div>
        <div>Corriente: <span id="currentReading">0.000</span> mA</div>
        <div><span id="statusBadge" class="status">Detenido</span></div>
      </div>
  </div>

  <!-- Controles -->
  <div class="controls">
      <button id="startBtn">Iniciar</button>
      <button id="stopBtn" disabled>Detener</button>
      <button id="resetBtn">Reiniciar</button>
  </div>

  <div style="margin-top: 20px; width: 400px;">
    <input type="range" id="voltageSlider" min="0" max="15" step="0.1" value="0" style="width: 100%;">
  </div>

  <script>
    class FranckHertzSimulator {
      constructor() {
        this.voltage = 0;
        this.isAutoSweep = false;
        this.isRunning = false;
        this.sweepInterval = null;
        this.data = [];
        this.initializeElements();
        this.initializeChart();
        this.bindEvents();
        this.updateDisplay();
      }
      initializeElements() {
        this.startBtn = document.getElementById('startBtn');
        this.stopBtn = document.getElementById('stopBtn');
        this.resetBtn = document.getElementById('resetBtn');
        this.voltageSlider = document.getElementById('voltageSlider');
        this.voltageValue = document.getElementById('voltageValue');
        this.currentReading = document.getElementById('currentReading');
        this.statusBadge = document.getElementById('statusBadge');
      }
      initializeChart() {
        const ctx = document.getElementById('franckHertzChart').getContext('2d');
        this.chart = new Chart(ctx, {
          type: 'line',
          data: {
            datasets: [{
              label: 'Corriente (mA)',
              data: [],
              borderColor: '#2563eb',
              backgroundColor: 'rgba(37, 99, 235, 0.1)',
              borderWidth: 2,
              fill: false,
              pointRadius: 0,
              tension: 0.1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: {
                type: 'linear',
                position: 'bottom',
                min: 0,
                max: 15,
                title: { display: true, text: 'Voltaje (V)' }
              },
              y: {
                min: 0,
                title: { display: true, text: 'Corriente (mA)' }
              }
            },
            plugins: {
              legend: { display: true }
            },
            animation: { duration: 0 }
          }
        });
      }
      bindEvents() {
        this.startBtn.addEventListener('click', () => this.handleStart());
        this.stopBtn.addEventListener('click', () => this.handleStop());
        this.resetBtn.addEventListener('click', () => this.handleReset());
        this.voltageSlider.addEventListener('input', (e) => this.handleManualVoltageChange(e));
      }
      calculateCurrent(v) {
        if (v <= 0) return 0;
        const excitationVoltage = 4.9;
        const baseGrowth = Math.exp(v / 8) - 1;
        const numPeaks = Math.floor(v / excitationVoltage);
        let current = baseGrowth;
        for (let i = 1; i <= numPeaks; i++) {
          const dropPosition = i * excitationVoltage;
          const distanceFromDrop = Math.abs(v - dropPosition);
          if (distanceFromDrop < 0.5) {
            const dropFactor = Math.exp(-Math.pow(distanceFromDrop * 4, 2));
            current *= 0.1 + 0.9 * (1 - dropFactor);
          }
        }
        const noise = (Math.random() - 0.5) * 0.02 * current;
        const damping = Math.exp(-v / 20);
        return Math.max(0, current * (0.8 + 0.4 * damping) + noise);
      }
      updateDisplay() {
        this.voltageValue.textContent = this.voltage.toFixed(1);
        this.voltageSlider.value = this.voltage;
        const current = this.calculateCurrent(this.voltage);
        this.currentReading.textContent = current.toFixed(3) + ' mA';
        const last = this.data[this.data.length - 1];
        if (!last || last.x !== this.voltage) {
          this.data.push({ x: this.voltage, y: current });
          if (this.data.length > 300) this.data = this.data.slice(-300);
          this.chart.data.datasets[0].data = this.data;
          this.chart.update('none');
        }
        this.statusBadge.textContent = this.isRunning ? 'Ejecutándose' : 'Detenido';
        this.statusBadge.classList.toggle('running', this.isRunning);
      }
      handleStart() {
        this.isAutoSweep = true;
        this.isRunning = true;
        this.startBtn.disabled = true;
        this.stopBtn.disabled = false;
        this.voltageSlider.disabled = true;
        this.sweepInterval = setInterval(() => {
          this.voltage += 0.1;
          if (this.voltage >= 15) {
            this.voltage = 15;
            this.handleStop();
          }
          this.updateDisplay();
        }, 100);
      }
      handleStop() {
        this.isRunning = false;
        this.startBtn.disabled = false;
        this.stopBtn.disabled = true;
        this.voltageSlider.disabled = false;
        if (this.sweepInterval) clearInterval(this.sweepInterval);
        this.sweepInterval = null;
        this.updateDisplay();
      }
      handleReset() {
        this.handleStop();
        this.isAutoSweep = false;
        this.voltage = 0;
        this.data = [];
        this.chart.data.datasets[0].data = [];
        this.chart.update();
        this.updateDisplay();
      }
      handleManualVoltageChange(e) {
        if (!this.isAutoSweep) {
          this.voltage = parseFloat(e.target.value);
          this.updateDisplay();
        }
      }
    }
    window.addEventListener('DOMContentLoaded', () => new FranckHertzSimulator());
  </script>
</body>
</html>
